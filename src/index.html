
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LuckyRoll - ËØæÂ†ÇÁÇπÂêçÁ≥ªÁªü</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+SC:wght@500;700;900&display=swap" rel="stylesheet">

    <!-- Tailwind Config -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              'festive': ['"Ma Shan Zheng"', 'cursive'],
              'sans': ['"Noto Sans SC"', 'sans-serif'],
            },
            colors: {
              'china-red': '#D7000F',
              'gold-main': '#FCC200',
              'gold-dark': '#E6AC00',
            },
            animation: {
              'bounce-slight': 'bounce-slight 0.5s infinite',
            },
            keyframes: {
              'bounce-slight': {
                '0%, 100%': { transform: 'translateY(-2%)' },
                '50%': { transform: 'translateY(0)' },
              }
            }
          },
        },
      }
    </script>
    
    <style>
      body {
        background-color: #C82E26;
        overflow: hidden; 
        user-select: none;
      }
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: #5e0000; }
      ::-webkit-scrollbar-thumb { background: #FCC200; border-radius: 4px; }
      
      .hidden { display: none !important; }
      
      /* Fade In Animation */
      .fade-in {
        animation: fadeIn 0.5s ease-in-out forwards;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
    </style>
<script type="importmap">
{
  "imports": {
    "xlsx": "https://aistudiocdn.com/xlsx@^0.18.5",
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.556.0",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "canvas-confetti": "https://aistudiocdn.com/canvas-confetti@^1.9.4"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="min-h-screen text-white font-sans">
    
    <!-- APP CONTAINER -->
    <div id="app" class="min-h-screen relative overflow-hidden flex flex-col font-sans selection:bg-yellow-300 selection:text-red-900">
        
        <!-- INTRO SCREEN -->
        <div id="intro-screen" class="flex-1 w-full h-full flex flex-col md:flex-row transition-opacity duration-500">
            <!-- Left Side -->
            <div class="flex-1 flex flex-col justify-center px-8 md:pl-24 z-20 pt-10 md:pt-0">
                 <div class="space-y-4 md:space-y-6 text-left">
                   <h1 class="text-6xl md:text-8xl font-bold text-[#FFFDD0] tracking-wide drop-shadow-md font-festive leading-tight">
                     ÂæíÂÑø‰ª¨Ôºå<br/>‰π¶ËÉå‰∫ÜÂêó
                   </h1>
                   <h2 class="text-3xl md:text-5xl font-bold text-[#FFD700] tracking-wider drop-shadow-sm font-festive">
                     ÊàëË¶ÅÂºÄÂßãÊäΩËÉå‰∫ÜÂì¶
                   </h2>
                 </div>

                 <div class="mt-12 md:mt-20 flex flex-wrap gap-6">
                   <!-- Start Button -->
                   <button id="btn-start" class="group relative bg-white text-[#C82E26] text-2xl md:text-3xl font-black py-4 px-10 rounded-full border-b-[6px] border-red-900 shadow-xl active:border-b-0 active:translate-y-2 transition-all hover:bg-gray-50 flex items-center gap-2 font-festive min-w-[200px] justify-center">
                     <i data-lucide="play" class="w-6 h-6 fill-current"></i>
                     ÂºÄÂßãÊäΩËÉå
                   </button>

                   <!-- Scope Button -->
                   <button id="btn-scope" class="group relative bg-white text-[#C82E26] text-2xl md:text-3xl font-black py-4 px-10 rounded-full border-b-[6px] border-red-900 shadow-xl active:border-b-0 active:translate-y-2 transition-all hover:bg-gray-50 flex items-center gap-2 font-festive min-w-[160px] justify-center">
                     <i data-lucide="settings-2" class="w-6 h-6"></i>
                     ËåÉÂõ¥
                   </button>
                 </div>
            </div>

            <!-- Right Side (TangSeng Image) -->
            <div class="flex-1 flex justify-center md:justify-end items-end relative overflow-hidden md:overflow-visible mt-4 md:mt-0">
                 <!-- Image Container -->
                 <div class="w-[85%] md:w-[95%] max-w-[800px] relative translate-y-0 md:-translate-y-[5%] md:mr-[-5%] lg:mr-0 pointer-events-none flex justify-center items-end h-full pb-0">
                   <img 
                      id="intro-hero-img" 
                      src="./tangseng.png" 
                      alt="Tang Seng" 
                      class="w-full h-auto drop-shadow-2xl object-contain max-h-[85vh]"
                      onerror="this.style.display='none'; document.getElementById('intro-fallback').classList.remove('hidden');"
                   >
                   <!-- Fallback SVG Container (Hidden by default, shows if png missing) -->
                   <div id="intro-fallback" class="hidden w-full h-full"></div>
                 </div>
            </div>
        </div>

        <!-- ACTIVE SCREEN -->
        <div id="active-screen" class="hidden fixed inset-0 flex flex-col z-10 transition-opacity duration-500">
           <!-- Header -->
           <div class="absolute top-0 left-0 right-0 p-4 md:p-8 flex justify-between items-start z-50">
              <h1 class="text-3xl md:text-5xl font-serif font-bold text-[#FFFDD0] drop-shadow-md whitespace-nowrap font-festive mt-2">
                ‰ªäÂ§©ËÉå‰π¶ÁöÑÊòØ
              </h1>
              <div class="flex flex-col gap-4 items-end">
                  <button id="btn-back" class="cursor-pointer bg-white/90 hover:bg-white text-red-700 text-lg md:text-xl font-bold py-2 px-6 rounded-full border-2 border-red-800 shadow-md transition-transform active:scale-95 flex items-center gap-2 pointer-events-auto font-festive">
                    <i data-lucide="arrow-left" class="w-5 h-5 md:w-6 md:h-6"></i>
                    ËøîÂõû
                  </button>

                  <button id="btn-stop" class="hidden cursor-pointer bg-[#FFD700] hover:bg-[#FFC200] text-red-900 text-2xl md:text-3xl font-black py-3 px-8 rounded-full border-b-[4px] border-red-900 shadow-xl active:border-b-0 active:translate-y-1 transition-all flex items-center gap-2 pointer-events-auto font-festive animate-bounce-slight">
                      <i data-lucide="target" class="w-6 h-6"></i>
                      Â∞±ÊòØTA
                  </button>
              </div>
           </div>

           <!-- Content -->
           <div class="flex-1 flex flex-col items-center justify-center w-full h-full relative p-4">
              
              <!-- Main Row: Wukong - Board - Bajie -->
              <!-- CHANGED: Increased top margin to mt-32 md:mt-56 to push it further down -->
              <div class="flex flex-row items-end justify-center w-full max-w-5xl gap-2 md:gap-4 mt-32 md:mt-56">
                  
                  <!-- Sun Wukong (Left) -->
                  <!-- Flipped to face right (towards board) -->
                  <div class="hidden md:block w-28 md:w-40 lg:w-48 transform -scale-x-100 translate-x-4 translate-y-2 transition-transform hover:scale-x-[-1.05] hover:scale-105 duration-300">
                      <div id="wukong-placeholder" class="w-full h-full drop-shadow-xl"></div>
                  </div>

                  <!-- Name Board (Center) -->
                  <div class="flex-none w-full max-w-[640px] z-20 mx-2">
                     <div class="w-full aspect-[16/9] md:aspect-[2.2/1] bg-[#FFF8E7] rounded-lg border-[10px] md:border-[14px] border-[#EDA545] shadow-2xl flex items-center justify-center relative overflow-hidden ring-4 ring-orange-800/20">
                        <div class="absolute inset-2 border-2 border-orange-200 pointer-events-none"></div>
                        <div class="relative z-10 w-full text-center px-4">
                          <span id="name-display" class="block font-sans font-extrabold text-[#1a1a1a] leading-none transition-all duration-100 text-6xl md:text-8xl opacity-100 blur-0 scale-100">
                            ÂáÜÂ§á
                          </span>
                        </div>
                        <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/30 to-transparent pointer-events-none"></div>
                     </div>
                  </div>
                  
                  <!-- Zhu Bajie (Right) -->
                  <div class="hidden md:block w-28 md:w-40 lg:w-48 -translate-x-4 translate-y-2 transition-transform hover:scale-110 duration-300">
                      <div id="bajie-placeholder" class="w-full h-full drop-shadow-xl"></div>
                  </div>

              </div>

              <!-- Celebration Text (Below Board) -->
              <div class="h-24 mt-6 flex justify-center items-center w-full">
                   <div id="celebration-text" class="hidden text-[#FFFDD0] text-5xl md:text-6xl font-bold animate-bounce drop-shadow-lg font-festive stroke-black stroke-2">
                      üéâ ÊäΩ‰∏≠Âï¶ÔºÅ üéâ
                   </div>
              </div>

           </div>
        </div>

        <!-- MODAL -->
        <div id="student-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
          <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[80vh] flex flex-col shadow-2xl overflow-hidden border-4 border-gold-main">
            <!-- Header -->
            <div class="bg-china-red p-4 flex justify-between items-center text-white">
              <div class="flex items-center gap-2">
                <i data-lucide="users" class="w-6 h-6 text-gold-main"></i>
                <h2 class="text-xl font-bold font-sans">ÁÇπÂêçËåÉÂõ¥ËÆæÁΩÆ</h2>
              </div>
              <button id="btn-close-modal" class="hover:bg-red-800 p-2 rounded-full transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
              </button>
            </div>

            <!-- Toolbar -->
            <div class="p-4 bg-gray-50 border-b flex flex-wrap gap-3 items-center justify-between">
              <div class="flex gap-2">
                 <button id="btn-import" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold shadow-sm transition-transform active:scale-95">
                    <i data-lucide="upload" class="w-4 h-4"></i> ÂØºÂÖ• Excel
                 </button>
                 <input type="file" id="file-input" class="hidden" accept=".xlsx, .xls">
                 <button id="btn-clear" class="flex items-center gap-2 px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg cursor-pointer border border-transparent hover:border-red-200">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> Ê∏ÖÁ©∫ÂêçÂçï
                 </button>
              </div>
              
              <div class="text-sm font-bold text-gray-600">
                Â∑≤ÈÄâ: <span id="active-count" class="text-china-red text-lg">0</span> / <span id="total-count">0</span>
              </div>
            </div>

            <!-- Action Bar -->
            <div class="px-4 py-2 bg-gray-100 flex gap-4 text-sm border-b">
                <button id="btn-select-all" class="text-blue-600 font-bold hover:underline">ÂÖ®ÈÄâ</button>
                <button id="btn-select-none" class="text-gray-500 hover:underline">ÂèñÊ∂àÂÖ®ÈÄâ</button>
            </div>

            <!-- List -->
            <div id="student-list" class="flex-1 overflow-y-auto p-4 grid grid-cols-2 sm:grid-cols-3 gap-3 bg-gray-50">
               <!-- Items injected here -->
            </div>

            <!-- Footer -->
            <div class="p-4 border-t bg-white flex justify-end">
                <button id="btn-confirm-modal" class="px-6 py-2 bg-china-red text-white font-bold rounded-lg shadow-lg hover:bg-red-700 transition-colors">
                    Á°ÆÂÆö
                </button>
            </div>
          </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
      // --- CONSTANTS & SVGs ---
      const BGM_URL = "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"; 
      
      // Updated Tang Seng SVG (Removed Staff)
      const SVG_TANGSENG_FALLBACK = `
        <svg viewBox="0 0 400 500" xmlns="http://www.w3.org/2000/svg" class="w-full h-full filter drop-shadow-2xl">
          <defs>
            <linearGradient id="ts-face" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="#FFF0E0"/>
              <stop offset="100%" stop-color="#FFDAB9"/>
            </linearGradient>
            <linearGradient id="ts-robe-inner" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#FFD700"/>
              <stop offset="100%" stop-color="#FFA000"/>
            </linearGradient>
             <linearGradient id="ts-robe-outer" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#D32F2F"/>
              <stop offset="100%" stop-color="#8E0000"/>
            </linearGradient>
            <radialGradient id="ts-jewel" cx="0.5" cy="0.5" r="0.5">
               <stop offset="0%" stop-color="#00E5FF"/>
               <stop offset="100%" stop-color="#006064"/>
            </radialGradient>
          </defs>
          <g transform="translate(200, 280) scale(1.3)">
            
            <!-- Staff REMOVED -->

            <!-- Body/Robe -->
            <path d="M-70 50 Q -90 180 0 180 Q 90 180 70 50 Z" fill="url(#ts-robe-inner)"/>
            <!-- Outer Kasaya -->
            <path d="M-70 50 Q -40 100 70 180 L 70 50 L 20 20 Z" fill="url(#ts-robe-outer)" opacity="0.9"/>
            <path d="M-70 50 C -80 120, -20 180, 70 180" fill="none" stroke="#B71C1C" stroke-width="2"/>
            
            <!-- Hands (Praying) -->
            <g transform="translate(0, 80)">
               <ellipse cx="-5" cy="0" rx="12" ry="10" fill="#FFF0E0" transform="rotate(-20)"/>
               <ellipse cx="5" cy="0" rx="12" ry="10" fill="#FFF0E0" transform="rotate(20)"/>
            </g>

            <!-- Head -->
            <g transform="translate(0, -30)">
               <!-- Ears -->
               <ellipse cx="-50" cy="10" rx="10" ry="18" fill="#FFF0E0"/>
               <ellipse cx="50" cy="10" rx="10" ry="18" fill="#FFF0E0"/>
               <!-- Face Shape -->
               <path d="M-45 -20 L -45 20 Q -45 70 0 70 Q 45 70 45 20 L 45 -20 Z" fill="url(#ts-face)"/>
               
               <!-- Crown -->
               <g transform="translate(0, -45)">
                 <path d="M-55 20 L -60 -20 Q 0 -60 60 -20 L 55 20 Z" fill="#D32F2F" stroke="#FFD700" stroke-width="3"/>
                 <!-- Crown Front Plate -->
                 <path d="M-50 20 Q 0 40 50 20 L 50 0 Q 0 10 -50 0 Z" fill="#FFD700"/>
                 <!-- Buddha Figures on Crown -->
                 <g transform="translate(0, -15)">
                    <circle cx="-30" cy="-5" r="8" fill="#FFECB3" stroke="#FF6F00" stroke-width="1"/>
                    <circle cx="0" cy="-15" r="10" fill="#FFECB3" stroke="#FF6F00" stroke-width="1"/>
                    <circle cx="30" cy="-5" r="8" fill="#FFECB3" stroke="#FF6F00" stroke-width="1"/>
                 </g>
               </g>

               <!-- Facial Features -->
               <g transform="translate(0, 10)">
                  <!-- Brows -->
                  <path d="M-25 -10 Q -15 -15 -5 -10" fill="none" stroke="#5D4037" stroke-width="2"/>
                  <path d="M25 -10 Q 15 -15 5 -10" fill="none" stroke="#5D4037" stroke-width="2"/>
                  <!-- Eyes -->
                  <circle cx="-18" cy="0" r="4" fill="#3E2723"/>
                  <circle cx="18" cy="0" r="4" fill="#3E2723"/>
                  <circle cx="-16" cy="-2" r="1.5" fill="#FFF"/>
                  <circle cx="20" cy="-2" r="1.5" fill="#FFF"/>
                  <!-- Mouth -->
                  <path d="M-8 15 Q 0 20 8 15" fill="none" stroke="#D84315" stroke-width="2" stroke-linecap="round"/>
                  <!-- Bindi -->
                  <circle cx="0" cy="-15" r="3" fill="#D32F2F"/>
               </g>
            </g>
          </g>
        </svg>`;

      const SVG_WUKONG = `
        <svg viewBox="0 0 200 220" xmlns="http://www.w3.org/2000/svg" class="w-full h-full">
           <path d="M60 150 Q 50 220 40 220 L 160 220 Q 150 220 140 150 Z" fill="#F59E0B" stroke="#B45309" strokeWidth="2" />
           <path d="M70 150 Q 100 180 130 150 L 115 180 L 85 180 Z" fill="#DC2626" />
           <path d="M60 80 Q 50 50 100 40 Q 150 50 140 80 Q 150 110 120 130 Q 100 140 80 130 Q 50 110 60 80" fill="#92400E" stroke="#78350F" strokeWidth="2" />
           <path d="M70 75 Q 70 55 90 65 Q 100 70 110 65 Q 130 55 130 75 Q 135 95 120 110 Q 100 125 80 110 Q 65 95 70 75" fill="#FFE4C4" />
           <ellipse cx="85" cy="85" rx="6" ry="8" fill="white" />
           <circle cx="85" cy="85" r="3" fill="black" />
           <ellipse cx="115" cy="85" rx="6" ry="8" fill="white" />
           <circle cx="115" cy="85" r="3" fill="black" />
           <path d="M90 105 Q 100 110 110 105" fill="none" stroke="#5A3A29" strokeWidth="2" />
           <path d="M65 60 Q 100 45 135 60" fill="none" stroke="#FCD34D" strokeWidth="6" strokeLinecap="round" />
           <circle cx="100" cy="52" r="6" fill="#FCD34D" stroke="#B45309" strokeWidth="1" />
           <circle cx="50" cy="180" r="15" fill="#FFE4C4" stroke="#D97706" strokeWidth="1" />
           <circle cx="150" cy="180" r="15" fill="#FFE4C4" stroke="#D97706" strokeWidth="1" />
        </svg>`;

      const SVG_BAJIE = `
        <svg viewBox="0 0 200 220" xmlns="http://www.w3.org/2000/svg" class="w-full h-full">
          <path d="M30 70 Q 10 50 20 90 Q 30 130 50 110" fill="#FECDD3" stroke="#F43F5E" strokeWidth="2" />
          <path d="M170 70 Q 190 50 180 90 Q 170 130 150 110" fill="#FECDD3" stroke="#F43F5E" strokeWidth="2" />
          <path d="M50 150 Q 30 220 20 220 L 180 220 Q 170 220 150 150 Z" fill="#1F2937" stroke="#000" strokeWidth="2" />
          <ellipse cx="100" cy="220" rx="40" ry="30" fill="#000" opacity="0.3" />
          <circle cx="100" cy="100" r="50" fill="#FFE4E6" stroke="#F43F5E" strokeWidth="2" />
          <path d="M65 65 L 135 65 L 125 35 L 75 35 Z" fill="#1F2937" stroke="#000" strokeWidth="2" />
          <rect x="70" y="35" width="60" height="5" fill="#374151" />
          <ellipse cx="100" cy="110" rx="18" ry="14" fill="#FDA4AF" stroke="#BE123C" strokeWidth="2" />
          <circle cx="94" cy="110" r="3.5" fill="#BE123C" />
          <circle cx="106" cy="110" r="3.5" fill="#BE123C" />
          <path d="M80 85 Q 88 80 96 85" fill="none" stroke="#000" strokeWidth="2" />
          <path d="M104 85 Q 112 80 120 85" fill="none" stroke="#000" strokeWidth="2" />
          <path d="M90 135 Q 100 140 110 135" fill="none" stroke="#BE123C" strokeWidth="2" />
        </svg>`;

      // --- STATE ---
      let students = [
        { id: '1', name: 'ÂàòÈõ®Ê¨£', active: true },
        { id: '2', name: 'ÈôàÊÄùÊòé', active: true },
        { id: '3', name: 'Á´†ÂÆáË¥§', active: true },
        { id: '4', name: 'È©¨Áê¶Áéâ', active: true },
        { id: '5', name: 'ËåÉÊÄùÈáè', active: true },
      ];
      
      let timer = null;
      let audio = null;
      let appState = 'IDLE'; // IDLE, ROLLING, SELECTED

      // --- ELEMENTS ---
      const els = {
        introScreen: document.getElementById('intro-screen'),
        activeScreen: document.getElementById('active-screen'),
        studentModal: document.getElementById('student-modal'),
        studentList: document.getElementById('student-list'),
        activeCount: document.getElementById('active-count'),
        totalCount: document.getElementById('total-count'),
        fileInput: document.getElementById('file-input'),
        nameDisplay: document.getElementById('name-display'),
        celebrationText: document.getElementById('celebration-text'),
        btnStop: document.getElementById('btn-stop'),
        // Placeholders
        introFallback: document.getElementById('intro-fallback'),
        wukong: document.getElementById('wukong-placeholder'),
        bajie: document.getElementById('bajie-placeholder'),
      };

      // --- INITIALIZATION ---
      function init() {
        // Audio
        audio = new Audio(BGM_URL);
        audio.loop = true;
        audio.volume = 0.5;

        // Inject SVGs into fallback and active screen placeholders
        els.introFallback.innerHTML = SVG_TANGSENG_FALLBACK;
        els.wukong.innerHTML = SVG_WUKONG;
        els.bajie.innerHTML = SVG_BAJIE;

        // Icons
        lucide.createIcons();

        // Bind Events
        document.getElementById('btn-start').onclick = startRoll;
        document.getElementById('btn-scope').onclick = openModal;
        document.getElementById('btn-back').onclick = goBack;
        document.getElementById('btn-stop').onclick = stopRoll;
        document.getElementById('btn-close-modal').onclick = closeModal;
        document.getElementById('btn-confirm-modal').onclick = closeModal;
        document.getElementById('btn-import').onclick = () => els.fileInput.click();
        els.fileInput.onchange = handleFileUpload;
        document.getElementById('btn-clear').onclick = clearList;
        document.getElementById('btn-select-all').onclick = () => toggleAll(true);
        document.getElementById('btn-select-none').onclick = () => toggleAll(false);
      }

      // --- LOGIC ---

      function updateNameDisplay(name) {
        els.nameDisplay.textContent = name;
        if (name.length > 3) {
            els.nameDisplay.classList.remove('text-6xl', 'md:text-8xl');
            els.nameDisplay.classList.add('text-5xl', 'md:text-7xl');
        } else {
            els.nameDisplay.classList.remove('text-5xl', 'md:text-7xl');
            els.nameDisplay.classList.add('text-6xl', 'md:text-8xl');
        }
      }

      function updateVisualState() {
        // App State effects
        if (appState === 'ROLLING') {
            els.nameDisplay.className = els.nameDisplay.className.replace(/opacity-100 blur-0 scale-100|scale-110 drop-shadow-2xl/g, ' ');
            els.nameDisplay.classList.add('opacity-80', 'blur-[2px]', 'scale-95');
            els.celebrationText.classList.add('hidden');
            els.btnStop.classList.remove('hidden');
        } else if (appState === 'SELECTED') {
            els.nameDisplay.className = els.nameDisplay.className.replace(/opacity-80 blur-\[2px\] scale-95/g, ' ');
            els.nameDisplay.classList.add('opacity-100', 'blur-0', 'scale-110', 'drop-shadow-2xl');
            els.celebrationText.classList.remove('hidden');
            els.btnStop.classList.add('hidden');
        } else {
            // IDLE
            els.nameDisplay.className = els.nameDisplay.className.replace(/opacity-80 blur-\[2px\] scale-95|scale-110 drop-shadow-2xl/g, ' ');
            els.nameDisplay.classList.add('opacity-100', 'blur-0', 'scale-100');
            els.celebrationText.classList.add('hidden');
            els.btnStop.classList.add('hidden');
        }
      }

      function startRoll() {
        const activeStudents = students.filter(s => s.active);
        if (activeStudents.length === 0) {
            alert("Ê≤°ÊúâÂèØÊäΩÂèñÁöÑÂ≠¶ÁîüÔºÅËØ∑ÂÖàÁÇπÂáª‚ÄúËåÉÂõ¥‚ÄùÂØºÂÖ•ÊàñÈÄâÊã©Â≠¶Áîü„ÄÇ");
            openModal();
            return;
        }

        appState = 'ROLLING';
        updateVisualState();
        
        // Show Active Screen
        els.introScreen.classList.add('hidden');
        els.activeScreen.classList.remove('hidden');

        // Play Music
        if (audio) {
            audio.currentTime = 0;
            audio.play().catch(e => console.warn(e));
        }

        // Start Loop
        if (timer) clearInterval(timer);
        timer = setInterval(() => {
            const r = Math.floor(Math.random() * activeStudents.length);
            updateNameDisplay(activeStudents[r].name);
        }, 50);
      }

      function stopRoll() {
        if (timer) {
            clearInterval(timer);
            timer = null;
        }
        if (audio) audio.pause();

        const activeStudents = students.filter(s => s.active);
        if (activeStudents.length > 0) {
            const r = Math.floor(Math.random() * activeStudents.length);
            updateNameDisplay(activeStudents[r].name);
        }

        appState = 'SELECTED';
        updateVisualState();
        triggerConfetti();
      }

      function goBack() {
        if (timer) clearInterval(timer);
        if (audio) {
            audio.pause();
            audio.currentTime = 0;
        }
        appState = 'IDLE';
        updateVisualState();
        updateNameDisplay("ÂáÜÂ§á");

        els.activeScreen.classList.add('hidden');
        els.introScreen.classList.remove('hidden');
      }

      function triggerConfetti() {
        const duration = 3000;
        const end = Date.now() + duration;
        (function frame() {
            confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#FFD700', '#FF0000', '#FFFFFF'] });
            confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#FFD700', '#FF0000', '#FFFFFF'] });
            if (Date.now() < end) requestAnimationFrame(frame);
        }());
      }

      // --- MODAL LOGIC ---

      function openModal() {
        renderStudentList();
        els.studentModal.classList.remove('hidden');
      }

      function closeModal() {
        els.studentModal.classList.add('hidden');
      }

      function renderStudentList() {
        els.studentList.innerHTML = '';
        const activeCount = students.filter(s => s.active).length;
        els.activeCount.textContent = activeCount;
        els.totalCount.textContent = students.length;

        if (students.length === 0) {
            els.studentList.innerHTML = `
                <div class="col-span-full flex flex-col items-center justify-center text-gray-400 py-10">
                    <i data-lucide="upload" class="w-12 h-12 mb-2 opacity-50"></i>
                    <p>ÊöÇÊó†Â≠¶ÁîüÔºåËØ∑ÂØºÂÖ• Excel Êñá‰ª∂ÔºÅ</p>
                </div>
            `;
            lucide.createIcons();
            return;
        }

        const fragment = document.createDocumentFragment();
        students.forEach(student => {
            const btn = document.createElement('button');
            btn.className = `flex items-center gap-3 p-3 rounded-lg border-2 transition-all ${
                student.active ? 'bg-white border-china-red shadow-md' : 'bg-gray-100 border-transparent opacity-60 grayscale'
            }`;
            btn.onclick = () => {
                student.active = !student.active;
                renderStudentList();
            };

            const icon = document.createElement('i');
            icon.setAttribute('data-lucide', student.active ? 'check-square' : 'square');
            icon.className = `w-5 h-5 shrink-0 ${student.active ? 'text-china-red' : 'text-gray-400'}`;
            
            const span = document.createElement('span');
            span.className = `font-bold truncate ${student.active ? 'text-gray-900' : 'text-gray-500'}`;
            span.textContent = student.name;

            btn.appendChild(icon);
            btn.appendChild(span);
            fragment.appendChild(btn);
        });
        els.studentList.appendChild(fragment);
        lucide.createIcons();
      }

      function toggleAll(active) {
        students.forEach(s => s.active = active);
        renderStudentList();
      }

      function clearList() {
        if (students.length === 0) {
            alert("ÂêçÂçïÂ∑≤ÁªèÊòØÁ©∫ÁöÑ‰∫ÜÔºåÊó†ÈúÄÊ∏ÖÁ©∫„ÄÇ");
            return;
        }
        
        if (confirm("Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂ≠¶ÁîüÂêçÂçïÂêóÔºü\n\nÊ≥®ÊÑèÔºöÊ≠§Êìç‰ΩúÂ∞ÜÂà†Èô§ÊâÄÊúâÊï∞ÊçÆÔºåÊÇ®ÈúÄË¶ÅÈáçÊñ∞ÂØºÂÖ•„ÄÇ")) {
            students = [];
            if(els.fileInput) els.fileInput.value = '';
            renderStudentList();
        }
      }

      function handleFileUpload(e) {
        if (e.target.files && e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    const data = evt.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    
                    const newStudents = [];
                    jsonData.forEach((row) => {
                        if (row[0] && typeof row[0] === 'string') {
                            newStudents.push({
                                id: crypto.randomUUID(),
                                name: row[0].trim(),
                                active: true
                            });
                        }
                    });

                    if (students.length === 0) {
                        students = newStudents;
                    } else {
                        students = [...students, ...newStudents];
                    }
                    renderStudentList();
                    els.fileInput.value = '';
                } catch (err) {
                    console.error(err);
                    alert("Excel Ëß£ÊûêÂ§±Ë¥•ÔºåËØ∑Á°Æ‰øùÊñá‰ª∂Ê†ºÂºèÊ≠£Á°ÆÔºà‰æãÂ¶ÇÔºöÁ¨¨‰∏ÄÂàó‰∏∫ÂßìÂêçÔºâ„ÄÇ");
                }
            };
            reader.readAsBinaryString(e.target.files[0]);
        }
      }

      // Run Init
      window.addEventListener('DOMContentLoaded', init);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
